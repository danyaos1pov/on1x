<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ON1X VPN MiniApp</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<style>
/* === ВСЕ СТИЛИ ОСТАЮТСЯ БЕЗ ИЗМЕНЕНИЙ (вставьте из вашего оригинального файла) === */
:root {
    --primary-color: #007bff;
    --secondary-color: #28a745;
    --bg-dark: #0d1117;
    --card-bg: #161b22;
    --text-color: #e6edf3;
    --accent-red: #dc3545;
}
* { box-sizing:border-box; margin:0; padding:0; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif; }
body { background:var(--bg-dark); color:var(--text-color); text-align:center; min-height:100vh; padding-bottom:50px; }
a { text-decoration:none; color:inherit; }

/* МОДАЛЬНОЕ ОКНО */
#modal-overlay{
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.7);backdrop-filter:blur(5px);
    display:none;justify-content:center;align-items:center;z-index:10002;
    opacity:0;transition:opacity .3s ease;
}
#modal-overlay.visible{display:flex;opacity:1;}
#modal-popup{
    background:var(--card-bg);padding:25px;border-radius:20px;
    border:1px solid rgba(255,255,255,.1);box-shadow:0 10px 30px rgba(0,0,0,.5);
    width:90%;max-width:380px;text-align:center;
    transform:scale(.9);transition:transform .3s cubic-bezier(.3,.7,.4,1.2);
}
#modal-overlay.visible #modal-popup{transform:scale(1);}
#modal-popup i{font-size:48px;color:var(--primary-color);margin-bottom:15px;}
#modal-title{font-size:1.5em;font-weight:700;margin-bottom:10px;color:var(--text-color);}
#modal-message{font-size:1em;color:#b0b8c2;line-height:1.6;margin-bottom:25px;}
#modal-close-button{
    background:var(--primary-color);color:#fff;border:none;border-radius:10px;
    padding:12px 0;width:100%;font-size:1em;font-weight:600;cursor:pointer;
    transition:background .2s;
}
#modal-close-button:hover,#modal-close-button:active{background:#0056b3;}

/* === ОСНОВНЫЕ СТИЛИ (вставьте все стили из оригинала сюда) === */
/* menu-grid, menu-card, button, back-button, page, splash и т.д. */
.menu-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;max-width:500px;margin:10px auto 20px auto;}
.menu-card{background:var(--card-bg);padding:15px 10px;border-radius:15px;display:flex;flex-direction:column;justify-content:center;align-items:center;cursor:pointer;transition:transform .2s,box-shadow .2s,border-color .2s;font-weight:600;color:var(--text-color);box-shadow:0 4px 10px rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.05);min-height:80px;font-size:.85em;}
.menu-card:hover,.menu-card:active{box-shadow:0 4px 12px rgba(0,0,0,.6);border-color:var(--primary-color);}
.menu-card i{font-size:24px;margin-bottom:5px;color:var(--primary-color);}
</style>
</head>
<body>

<!-- ВАШИ СТРАНИЦЫ (home, subscription, buy и т.д.) -->
<div id="app-container" style="position:relative;min-height:100vh;">

    <!-- HOME С НОВОЙ КНОПКОЙ -->
    <div id="home" class="page">
        <h1>ON1X VPN</h1>
        
        <div class="menu-grid">
            <!-- ВАШИ КНОПКИ -->
            <div class="menu-card" onclick="showPage('install')"><i class="fas fa-download"></i>Установка</div>
            <div class="menu-card" onclick="showPage('status')"><i class="fas fa-shield-alt"></i>Статус систем</div>
            <div class="menu-card" onclick="showPage('faq')"><i class="fas fa-lightbulb"></i>FAQ</div>
            <div class="menu-card" onclick="showPage('support')"><i class="fas fa-headset"></i>Поддержка</div>
            <div class="menu-card" onclick="window.location.href='https://t.me/on1xVPN_bot?start=f_5371698'"><i class="fas fa-user-plus"></i>Пригласить друзей</div>
            
            <!-- ✅ КНОПКА ТЕСТИРОВАНИЕ -->
            <div class="menu-card" onclick="openTestingLink()">
                <i class="fas fa-vial"></i>Тестирование
            </div>
        </div>
    </div>

    <!-- ВСТАВЬТЕ ОСТАЛЬНЫЕ СТРАНИЦЫ ИЗ ОРИГИНАЛА -->

</div>

<!-- МОДАЛЬНОЕ ОКНО -->
<div id="modal-overlay">
    <div id="modal-popup">
        <i class="fas fa-paper-plane"></i>
        <h3 id="modal-title">Перейти в Telegram</h3>
        <p id="modal-message">Для того, чтобы открыть сообщение, необходимо перейти в Telegram</p>
        <button id="modal-close-button">Перейти в Telegram</button>
    </div>
</div>

<script>
/* === ✅ ИНИЦИАЛИЗАЦИЯ TELEGRAM WEBAPP === */
let TelegramWebApp = null;
try {
    TelegramWebApp = window.Telegram?.WebApp;
    if (TelegramWebApp) {
        TelegramWebApp.ready();
        TelegramWebApp.expand();
    }
} catch (e) {
    console.log('Telegram WebApp не доступен');
}

/* === МОДАЛЬНОЕ ОКНО === */
const modalOverlay = document.getElementById('modal-overlay');
const modalTitle = document.getElementById('modal-title');
const modalMessage = document.getElementById('modal-message');
const modalBtn = document.getElementById('modal-close-button');

function showModal(title, message, btnText = 'Понятно', onClick = null) {
    modalTitle.textContent = title;
    modalMessage.textContent = message;
    modalBtn.textContent = btnText;
    
    // Сохраняем предыдущий обработчик
    const prevOnclick = modalBtn.onclick;
    modalBtn.onclick = () => {
        hideModal();
        if (onClick) onClick();
        if (prevOnclick) prevOnclick();
    };
    
    modalOverlay.classList.add('visible');
}

function hideModal() {
    modalOverlay.classList.remove('visible');
}

modalOverlay.addEventListener('click', e => {
    if (e.target === modalOverlay) hideModal();
});

/* === ✅ ФУНКЦИЯ ТЕСТИРОВАНИЯ (ИСПРАВЛЕННАЯ) === */
function openTestingLink() {
    const tgLink = 'https://t.me/on1xVPN_bot?start=f_5372173';
    
    // 1. СРАЗУ открываем ссылку в Telegram
    window.open(tgLink, '_blank');
    // Альтернатива: window.location.href = tgLink;
    
    // 2. Показываем модалку
    showModal(
        'Перейти в Telegram',
        'Для того, чтобы открыть сообщение, необходимо перейти в Telegram',
        'Перейти в Telegram',
        () => {
            // ✅ 3+ СПОСОБА ЗАКРЫТИЯ MiniApp
            try {
                // Способ 1: Официальный Telegram WebApp
                if (TelegramWebApp && TelegramWebApp.close) {
                    TelegramWebApp.close();
                    return;
                }
            } catch (e) {}
            
            try {
                // Способ 2: Через postMessage
                window.parent.postMessage({ event: 'web_app_close' }, '*');
            } catch (e) {}
            
            try {
                // Способ 3: Принудительное закрытие
                if (window.TelegramWebApp && window.TelegramWebApp.close) {
                    window.TelegramWebApp.close();
                }
            } catch (e) {}
            
            // Способ 4: Если ничего не работает - редирект на about:blank
            window.location.href = 'about:blank';
        }
    );
}

/* === ВАШИ ОСТАЛЬНЫЕ ФУНКЦИИ (showPage, тарифы и т.д.) === */
// Вставьте сюда все функции из оригинала

/* === ЗАПУСК === */
document.addEventListener('DOMContentLoaded', () => {
    // Ваш код запуска splash screen
    console.log('✅ MiniApp готов. WebApp:', !!TelegramWebApp);
});
</script>
</body>
</html>
